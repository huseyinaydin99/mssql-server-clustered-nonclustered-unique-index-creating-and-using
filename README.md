## mssql-server-clustered-nonclustered-unique-index-creating-and-using
```
MSSQL Server üzerinde verileri çok performanslı bir şekilde kullanabilmek adına index'ler üzerinde çalışmalar yapıyorum.
Clustered, nonclustered ve unique index yapılarını öğrendim.
```

```
SET STATISTICS IO ON;
SELECT *
FROM [CARPLATES].[dbo].[PLATES]
WHERE BRAND LIKE '%Tof%';

--79544 YUKARIDAKI SELECT SORGUSU 79544 ADET SAYFA(PAGE) OKUMUS.
SELECT 79544 * 8 --BU SORGU 79544 ADET SAYFA(PAGE)'NIN KB KARSILIGI DEMEKTIR.
SELECT 79544 * 8 / 1024 --BU SORGU 79544 ADET SAYFA(PAGE)'NIN MB KARSILIGI DEMEKTIR.
SELECT 79544 * 8 / 1024.01 --BU SORGU 79544 ADET SAYFA(PAGE)'NIN MB KARSILIGI DEMEKTIR. YUVARLAMASIZ HALI .01 EKLENDI.

SP_SPACEUSED 'PLATES'; --ILGILI TABLO HAKKINDA DEPOLAMA BILGILERINI GETIRIR. KAC KB YER KAPLIYOR? KAC SATIRDAN OLUSUYOR VS. GIBI.

SET STATISTICS IO ON;
SELECT *
FROM PLATES
WHERE YEAR_ = '2019';

--NONCLUSTERED INDEX YANI FIZIKSEL OLARAK SIRAYA SOKULMAMIS INDEX DEMEKTIR.
--CLUSTERED INDEX FIZIKSEL SIRALAMALI INDEX'TIR ID KOLUNU CLUSTERED'DIR.
--ID KOLONU OTOMATIK ARTTIGI ICIN SIRALAMALIDIR YANI CLUSTEREDTIR!
--BIZ YENI BIR NONCLUSTERED INDEX EKLEYIP DIGER KOLONLARI INCLUDE(DAHIL) EDERSEK TABLO BOYUTU 
--YAKLASIK 2 KAT BUYUR.
--NONCLUSTERED INDEX OLUSTURMA SCRIPTI:
CREATE NONCLUSTERED INDEX IX1 ON PLATES(
YEAR_
);

--BU SELECT SORGUSU CITYNR KOLONUNA GORE INDEX VARSA 1479 ADET SAYFA(PAGE) OKUYOR.
--BU SELECT SORGUSU CITYNR KOLONUNA GORE INDEX YOKSA 77904 ADET SAYFA(PAGE) OKUYOR.
SELECT 77904 * 8 / 1024.01 --BUDA DEMEK OLUYOR KI 608 MB VERI.
SELECT 1479 * 8 / 1024.01 --BUDA DEMEK OLUYOR KI 11 MB VERI.
--11 MB OLMASI YUKSEK HIZLI TREN DEMEKTIR BUYUUUUUK VERILERDE. (:
SET STATISTICS IO ON;
SELECT *
FROM PLATES
WHERE CITYNR = 33;

USE [CARPLATES]
GO
CREATE NONCLUSTERED INDEX IX2
ON [dbo].[PLATES] ([CITYNR])
INCLUDE ([CARID],[PLATE],[LICENCEDATE],[TITLE],[BRAND],[MODEL],[YEAR_],[FUEL],[SHIFTTYPE],[MOTORVOLUME],[MOTORPOWER],[COLOR],[CASETYPE])
GO

--NOT: MSSQL SERVER'A BIRDEN FAZLA INDEX KULLANIMINDA SORGULAMA YAPARKEN
--HANGI INDEX DAHA AZ MALIYETLIYSE SQLSERVER ONU ANLAR VE O EN AZ MALIYETLI INDEX'I KULLANMAYI
--TERCIH EDER. BUDA DEMEK OLUYOR KI HEM ZAMAN HEM DONANIM MALIYETINDEN TASARRUF.

--NOT: UNIQUE INDEX'TE SISTEM ZATEN UNIQUE(BENZERSIZ-AYNISINDAN BIR TANE DAHA OLMAYAN) KAYIT OLDUGUNU
--BILDIGI ICIN DEVAMINI ARAMIYOR CUNKU YOK.
--EGER TABLOMUZDA TCNO GIBI PLAKA GIBI USERNAME GIBI UNIQUE(BENZERSIZ) KOLONLAR VARSA
--VE INDEX OLUSTURULMASI GEREKIYORSA O INDEX UNIQUE OLMALIDIR KI SISTEM PERFORMANSLI CALISSIN.


--BU SELECT SORGUSU CITYNR KOLONUNA GORE INDEX VARSA 3 ADET SAYFA(PAGE) OKUYOR.
--BU SELECT SORGUSU CITYNR KOLONUNA GORE INDEX YOKSA 78270 ADET SAYFA(PAGE) OKUYOR.
SELECT 78270 * 8 / 1024.01 --BUDA DEMEK OLUYOR KI 611 MB VERI.
SELECT 3 * 8 / 1024.01 --BUDA DEMEK OLUYOR KI 0.0234372 MB VERI.
--0 KUSUR MB OLMASI YUKSEK HIZLI TREN DEMEKTIR BUYUUUUUK VERILERDE. (:
--UNIQUE INDEX'LERDE SISTEM AFEDERSINIZ KOPEK GIBI CALISIYOR :D :D :D
SET STATISTICS IO ON;
SELECT *
FROM PLATES
WHERE PLATE = '01 HVH 47';

--BENZERSIZ BIR KOLON ICIN INDEX OLUSTURMA HEMDE DIGER KOLONLARIN INCLUDE(DAHIL) EDILMESI
--KEYLOOKUP YAPMAMASI ICIN
CREATE UNIQUE NONCLUSTERED INDEX IX3 ON PLATES
(
	PLATE ASC
)
INCLUDE([ID],[CARID],[LICENCEDATE],[CITYNR],[TITLE],[BRAND],[MODEL],[YEAR_],[FUEL],[SHIFTTYPE],[MOTORVOLUME],[MOTORPOWER],[COLOR],[CASETYPE]) WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, IGNORE_DUP_KEY = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF);

-- #### INDEX BOZULMALARI #### :>
--BIZ STATIC BIR TABLOYA INDEX KOYARAK VERIYI HIZLI BIR SEKILDE OKUYABILIYORUZ.
--ANCAK STATIC OLMAYIPTA SUREKLI DEGISEN DINAMIK BIR VERI TABLOSU
--VARSA YANI SUREKLI YENI KAYITLAR GELIYORSA INDEX BOZULMASI OLUYOR DEMEKTIR.

--SQLSERVER'DA CLUSTERED INDEX YANI FIZIKSEL OLARAK SIRALANAN KOLON ID KOLONU OLARAK BELIRLENIR.
--ID KOLONU BIRINCIL ANAHTAR(PRIMARY KEY) OLDUGUNDAN DOLAYI FIZIKSEL SIRALAMA PRIMARY KEY KOLONUDUR.
--YANI ID'DIR.

--BURASI FIZIKSEL SIRALAMA YANI CLUSTERED INDEX
/*
-------------------------------
|ID       | NAME_             |
|1        | BURAK             |
|2        | CELAL             |
|3        | ZEHRA             |
|4        | ALI               |
|5        | BEKIR             |
|6        | AHMET             |
|7        | AYSE              |
-------------------------------
*/

--BURASI ISE NONCLUSTERED INDEX YANI INDEX NAME_ KOLONUNA VERILMIS.
/*
-------------------------------
|ID       | NAME_             |
|4        | ALI               |
|6        | AHMET             |
|7        | AYSE              |
|1        | BURAK             |
|5        | BEKIR             |
|2        | CELAL             |
|3        | ZEHRA             |
-------------------------------
*/

--YUKARIDA GORULEN KISIM ASLINDA TABLO GORUNUMUDUR.
--TABLOLARDAKI VERILER ASLINDA GERI PLANDA DEPOLAMA AYGITINDA PAGE(SAYFALAR)'LER HALINDE TUTULUYOR.
--HER BIR PAGE(SAYFA) 8 KB OLARAK DEPOLAMA AYGITINDA(HDD - SSD - SSHD - FLASH DISK - TASINABILIR HDD, SSD) TUTULUYOR.

--PAGE 1 - 8 KB
/*
--------------
ID | NAME_
1  | SELAMI
2  | CUMALI
3  | BESTAMI
*/

--PAGE 2 - 8 KB
/*
--------------
ID | NAME_
4  | NECATI
5  | AYFER
6  | ULFER
*/

--NOT: YENI BIR KAYIT GELDIGINDE YENI BIR PAGE ACILIR VE ID KALDIGI YERDEN BOYLE BOYLE DEVAM EDER GIDER.
--NOT: PEKI INDEX TARAFINDA BU IS NASIL OLUYOR?

--PAGE 3 - 8 KB
/*
--------------
ID | NAME_
7  | HUSEYIN
8  | YASIN
9  | RUMEYSA
*/

--INDEX PAGE(SAYFA)'LAR:
--PAGE 1 - 8 KB
/*
--------------
ID | NAME_
5  | AYFER     - <--- NOT: ALI DIYE BIR KAYIT GELIRSE ALFABETIK SIRALAMA OLDUGU ICIN KAYIT BURAYA GELECEK.
3  | BESTAMI   --DOLAYISIYLA KAYITLAR BIR SONRAKI PAGELERE KAYDIRILACAK CUNKU PAGE SINIRI MAX 8 KB.
2  | CUMALI    --DOLAYISIYLA KAYITLAR SONRAKI PAGE'LERE KAYDIRILACA�I ICIN HEM ZAMAN, HEM CPU, HEM RAM, HEM OKUMA, HEM YAZMA, 
*/             --HEM ZAMAN, HEM ELEKTRIK MALIYETI DEMEK OLUYOR.
               --AMA BOYLE BIR SEY YOK. YAPILMIYOR. PEKI GERCEKTE OLAN NE O ZAMAN?
			   --GERCEKTE OLAN SU:
			   --YENI GELEN KAYITLAR SONA EKLENIYOR.
			   --YENI PAGE OLUSTURULUYOR / ACILIYOR.
			   --YENI OLUSAN PAGE'YE EKLENIYOR.
			   --DOLAYISIYLA NAME_ KOLONUNA GORE SIRALAMA BOZULUYOR.
			   --BU DA INDEX BOZULMASI DEMEK OLUYOR.
--PAGE 2 - 8 KB
/*
--------------
ID | NAME_
4  | NECATI
6  | ULFER
1  | SELAMI
*/

--PAGE 3 - 8 KB (YENI EKLENEN / OLUSTURULAN PAGE) [FRAGMENTATION / SIRASIZ VE BOZUK BIR YAPI]
/*
--------------
ID | NAME_
7  | SALIH
8  | HASAN
9  | ZUBEYIR
*/

--BU DURUM SUNA BENZER.
--TELEFON REHBERIMIZIN OLDUGUNU DUSUNELIM.
--REHBERDE OLAN ISIMLER ALFABETIK OLARAK SIRALI.
--SONUNDA DA 3 SAYFA BOS OLSUN MISAL OLARAK.
--BIZ SON 3 SAYFAYA YENI KAYITLAR EKLEYELIM KALEMLE.
--NE OLDU? YENI KAYITLAR EKLENINCE SIRA BOZULDU.

/*
INDEX'LER BELLI ZAMANLARDA UZERINE YENI KAYIT GELDIKCE BOZULMAYA UGRARLAR.
O REHBERIN YENIDEN SIFIRDAN SIRALI SEKILDE DUZELTILMESI GEREKIR.
BU DUZELTME ISLEMININ ADI REBUILD(YENIDEN INSA)'DIR.
GENELDE DATABASE BAKIM PLANLARINDAN BIRIDIR.
HAFTADA BIR, AYDA BIR, DURUMA GORE HER GECE GIBI...

BAZI SISTEMLER 7 / 24 ARALIKSIZ CALISIR VE KAPATMAYA FIRSAT OLMAYABILIR.
BU DURUMDA COK SIK BOZULAN INDEX'LERI DAHA UZUUUUN VADEDE BOZULABILEN INDEX'LER HALINE GETIRMEMIZ GEREKIR.
BUNUN ICIN SOYLE BIR YONTEM VAR:
ORNEK :>
TELEFON REHBERININ TUM SAYFALARINI DOLDURMAK YERINE HER SAYFADA %40 BOSLUK BIRAKSAK
YENI GELEN HER KAYDI SAYFA SONUNA DEGILDE ILGILI SAYFANIN %40'LIK BOS KISMINA EKLESEK BU BIZIM
INDEX'LERIMIZIN BOZULMA SURESINI COOK UZATACAKTIR.
AYNI MANTIK REHBERDE OLDUGU GIBI MSSQLSERVER'DA DA GECERLIDIR.
*/

--INDEX PAGE(SAYFA)'LAR:
--PAGE 1 - 8 KB %40'I BOSLUK
/*
--------------
ID | NAME_
5  | AYFER     
3  | BESTAMI   
2  | CUMALI    
10 | CELAL --YENI GELEN KAYIT BU <<<---- --C HARFI ILE BASLADIGI ICIN PAGE1'IN %40'LIK BOSLUK KISMINA	 
   |                                     --EKLENDI VE INDEX BOZULMADI. BOYLELIKLE YENI PAGE ACILMADI VE SIRA BOZULMADI!!!!!!
   |
--------------  
*/               

--PAGE 2 - 8 KB %40'I BOSLUK
/*
--------------
ID | NAME_
4  | NECATI
6  | ULFER
1  | SELAMI
11 | SENA --YENI GELEN KAYIT BU <<<---- --S HARFI ILE BASLADIGI ICIN PAGE2'IN %40'LIK BOSLUK KISMINA	 
   |                                     --EKLENDI VE INDEX BOZULMADI. BOYLELIKLE YENI PAGE ACILMADI VE SIRA BOZULMADI!!!!!!
   |
   |
--------------
*/

/*
##    BOYLELIKLE YENI PAGE ACILMADI VE SIRA BOZULMADI!!!!!!    ##
KOCAMAN BIR DATA'NIN ICINDE KAYDIRMA SOZ KONUSU OLMADI SADECE 8 KB'LIK PAGE ICINDE KAYDIRMA SOZ KONUSU OLDU.
BU DA COK AZ
HEM ZAMAN, HEM CPU, HEM RAM, HEM OKUMA, HEM YAZMA, 
HEM ZAMAN, HEM ELEKTRIK
MALIYET DEMEKTIR.

PERFORMANS SAGLAR.
*/
--NOT %40'LIK BOSLUGA VERDIGIMIZ ISIM FILL FACTOR(DOLULUK ORANI)'DIR.
--BIZ BIR PAGE'YE FILL FACTOR VERIRSEK BOZULMA ORANI OLDUKCA AZALIR.
--2 GUNDE, 3 GUNDE BOZULACAGINA ARTIK 2 AYDA BOZULUR YAHUT 15 GUNDE BOZULUR.
--FRAGMENTASYON DEGERI %40 ILA %50'LERE KADAR GELDIYSE KESINLIKLE O INDEX'IN DUZELTILMESI GEREKLIDIR.
--INDEX'LERIN BOZULMASI ARAMA(SELECT) PERFORMANSINA DOGRUDAN YANSIYACAKTIR.
--SISTEM BIR YERE KADAR SIRALI SEKILDE ARAYACAK BIR YERDEN SONRA SIRASIZ SEKILDE BAKMAYA BASLAYACAK.

--1. YONTEM REBUILD
--BOZULAN INDEX'I DUZELTMEK ICIN ONCE ILGILI TABLONUN ILGILI INDEX'INE GIDILIR.
--UZERINE SAG TIKLANIR VE REBUILD SECENEGINE TIKLANIR VE BUILD ISLEMI OK BUTONUNA TIKLANARAK YAPILIR.
--INDEX'IN BOZULMASI ICIN RASTGELE BIR TON KAYIT ATCAZ. INSERT x 2500. ODA BOZULCAK.
--____
--2. YONTEM REORGANIZE
--BOZULAN INDEX'I DUZELTMEK ICIN ONCE ILGILI TABLONUN ILGILI INDEX'INE GIDILIR.
--UZERINE SAG TIKLANIR VE REORGANIZE SECENEGINE TIKLANIR VE REORGANIZE ISLEMI OK BUTONUNA TIKLANARAK YAPILIR.
--INDEX'IN BOZULMASI ICIN RASTGELE BIR TON KAYIT ATCAZ. INSERT x 2500. ODA BOZULCAK.

--# REBUILD ILE REORGANIZE'NIN FARKI NEDIR?
------------------------------------------------------------------------------------------
--! ORNEK OLARAK REORGANIZE:>
--MASANIN USTUNDE KAGITLAR COK DAGINIK BIR SEKILDE DURUYOR.
--BAZI DURUMLAR COK DAGINIK OLURSA YERE INDIRMEK GEREKEBILIR.
--YERE INMEDEN HIZLI VE DAHA DETAYSIZ HALLETMEK ICIN REORGANIZE YAPILIR.

--! ORNEK OLARAK REBUILD:>
--MASANIN USTUNDE KAGITLAR COK DAGINIK BIR SEKILDE DURUYOR.
--BAZI DURUMLAR COK DAGINIK OLURSA YERE INDIRMEK GEREKEBILIR.
--MASANIN UZERINDE YAPMA IMKANI YOKTUR CUNKU COOOK ASIRI DAGINIKTIR.
--BOYLE DURUMLARDA YERE INDIRIP DAHA DETAYLI DUZENLEYIP SONRADAN MASANIN UZERINE TASIMA ICIN REBUILD YAPILIR.

--! PEKI HANGI DURUMLARDA REBUILD? HANGI DURUMLARDA REORGANIZE KULLANILMALIDIR.
--GENEL OLARAK SU SOYLENIR:
--FRAGMENTATION YANI INDEX BOZULMASI %40'IN UZERIYSE REBUILD YAP YANI TAM AYRINTILI INDEX DUZELTMESI YAP.
--YOK EFENDIM INDEX BOZULMASI %40'IN ALTINDAYSA REORGANIZE YAP. SEKLINDEDIR.!
------------------------------------------------------------------------------------------

--TUM INDEX'LER UZERINDE REBUILD YAPMAK ICIN ILGILI TABLONUN UZERINE GELINIR.
--TABLONUN ALT KISMINDA INDEXES BASLIGINA SAG TIKLANIR, REBUILD ALL SECENEGI SECILIR VE OK BUTONUNA BASILARAK REBUILD YAPILIR.
--UZUN SUREBILIR DONANIM KAYNAKLARINA BAGLI OLARAK YA DA VERININ COK OLMASINA BAGLI OLARAK.

--FILL FACTOR(DOLULUK ORANI UYGULANMASI) :>
--ILGILI TABLONUN ILGILI INDEX'INE GIDILIP UZERINE CIFT TIKLANDIKTAN SONRA OPTIONS KISMINA GIDILIR.
--ORADAKI FILL FACTOR KISMINA 60 YAZARSAK EGER O PAGE'NIN DOLU KISMI %60 OLUR BOS KISMI ISE %40 OLUR.
--ILGILI INDEX'IN UZERINE CIFT TIKLAYIP DOLULUK ORANINA VE FRAGMENTATIONA'A BAKABILIRIZ.

--INDEX OLUSTURMA ASAMASINDA FILL FACTOR EKLEME SCRIPTI:>
CREATE NONCLUSTERED INDEX IX2 ON PLATES
(
	CITYNR ASC
)
INCLUDE([ID],[CARID],[PLATE],[LICENCEDATE],[TITLE],[BRAND],[MODEL],[YEAR_],[FUEL],[SHIFTTYPE],[MOTORVOLUME],[MOTORPOWER],[COLOR],[CASETYPE])
WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, FILLFACTOR = 70, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF);
--YUKARIDAKI WITH KISMINDA FILL FACTOR'UN YER ALDIGINA DIKKAT EDINIZ. %70 YAZIYOR ORADAN. BU DURUMDA PAGE DOLULUK ORANI %70 OLUYOR. BOSLUK ORANI ISE %30.

--ONEMLI:> HER SEFERINDE FILL FACTOR GIRMEKLE UGRASMAYIM SERVER BAZINDA FILL FACTOR UYGULAYIM DIYORSANIZ
--OBJECT EXPLORER(NESNE GEZGININ)'NE SAG TIKLAYIN VE PROPERTIES SECENEGINE BASIN. 
--ACILAN PENCEREDEN DATABASE SETTINGS(VERITABANI AYARLARI) KISMINA GELIN.
--DEFAULT FILL FACTOR(VARSAYILAN DOLULUK FAKTORUNU) %70 YAPIN!
--HEPSI BU KADAR.
--IYI CALISMALAR BASARILAR.
```
